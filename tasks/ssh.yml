- name: Install openssh-server
  apt:
    name: openssh-server
    state: latest
  when: not ssh_bootstrap
  notify:
    - Restarts sshd

- name: Deploys sshd config
  template:
    src: "../templates/sshd_config.j2"
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0644
    backup: yes
  when: not ssh_bootstrap
  notify:
    - Restarts sshd

- name: Deploys authorized ssh keys for users
  authorized_key:
    user: "{{item.0.user | default('root')}}"
    key: "{{item.0.key}}"
    path: "{{ ansible_env.HOME + '/' + item.1 }}"
    state: present
  with_items: 
    - "{{ ssh_keys }}"
    - "{{ ssh_keys_files }}"

  tags: ["ssh:keys"]

- name: Adds ferm filtering
  template:
    src: "../templates/ferm.j2"
    dest: /etc/ferm/filter-input.d/60_ssh.conf
  when: ferm_enabled
  tags: ["ferm"]
  notify: Restart ferm
